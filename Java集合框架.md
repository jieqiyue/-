

- List ï¼š`ArrayList`ã€`LinkedList`ã€`Vector`ã€`CopyOnWriteArrayList`
- Setï¼š`HashSet`ã€`TreeSet`ã€`LinkedHashSet`
- Queueï¼š`PriorityQueue`
- Mapï¼š`HashMap`ï¼Œ`TreeMap`ï¼Œ`LinkedHashMap`
- fast-failï¼Œfast-safe æœºåˆ¶
- æºç åˆ†æï¼ˆåº•å±‚æ•°æ®ç»“æ„ï¼Œæ’å…¥ã€æ‰©å®¹è¿‡ç¨‹ï¼‰ã€çº¿ç¨‹å®‰å…¨ã€‚



### ArrayList

> æ„é€ å‡½æ•°

```java
// ç¬¬ä¸€ç§
    public ArrayList(int initialCapacity) {
        // åˆå§‹åŒ–å®¹é‡å¤§äº 0 æ—¶ï¼Œåˆ›å»º Object æ•°ç»„
        if (initialCapacity > 0) {
            this.elementData = new Object[initialCapacity];
        // åˆå§‹åŒ–å®¹é‡ç­‰äº 0 æ—¶ï¼Œä½¿ç”¨ EMPTY_ELEMENTDATA å¯¹è±¡
        } else if (initialCapacity == 0) {
            this.elementData = EMPTY_ELEMENTDATA;
        // åˆå§‹åŒ–å®¹é‡å°äº 0 æ—¶ï¼ŒæŠ›å‡º IllegalArgumentException å¼‚å¸¸
        } else {
            throw new IllegalArgumentException("Illegal Capacity: "+
                                               initialCapacity);
        }
    }

// ç¬¬äºŒç§
public ArrayList() {
    this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;
}

// ç¬¬ä¸‰ç§
  public ArrayList(Collection<? extends E> c) {
        // å°† c è½¬æ¢æˆ Object æ•°ç»„
        elementData = c.toArray();
        // å¦‚æœæ•°ç»„å¤§å°å¤§äº 0
        if ((size = elementData.length) != 0) {
            // defend against c.toArray (incorrectly) not returning Object[]
            // (see e.g. https://bugs.openjdk.java.net/browse/JDK-6260652)
            // å¦‚æœé›†åˆå…ƒç´ ä¸æ˜¯ Object[] ç±»å‹ï¼Œåˆ™ä¼šåˆ›å»ºæ–°çš„ Object[] æ•°ç»„ï¼Œå¹¶å°† elementData èµ‹å€¼åˆ°å…¶ä¸­ï¼Œæœ€åèµ‹å€¼ç»™ elementData ã€‚
            if (elementData.getClass() != Object[].class)
                elementData = Arrays.copyOf(elementData, size, Object[].class);
        // å¦‚æœæ•°ç»„å¤§å°ç­‰äº 0 ï¼Œåˆ™ä½¿ç”¨ EMPTY_ELEMENTDATA ã€‚
        } else {
            // replace with empty array.
            this.elementData = EMPTY_ELEMENTDATA;
        }
    }
```



> æ‰©å®¹

è°ˆåˆ°æ‰©å®¹ï¼Œé¦–å…ˆçœ‹çœ‹æ‰©å®¹å‡½æ•°ã€‚

```java
    private Object[] grow(int minCapacity) {
        int oldCapacity = elementData.length;
        // å¦‚æœåŸå®¹é‡å¤§äº 0 ï¼Œæˆ–è€…æ•°ç»„ä¸æ˜¯ DEFAULTCAPACITY_EMPTY_ELEMENTDATA æ—¶ï¼Œè®¡ç®—æ–°çš„æ•°ç»„å¤§å°ï¼Œå¹¶åˆ›å»ºæ‰©å®¹
        if (oldCapacity > 0 || elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
            int newCapacity = ArraysSupport.newLength(oldCapacity,
                    minCapacity - oldCapacity, /* minimum growth */
                    oldCapacity >> 1           /* preferred growth */);
// ä¸Šé¢è¿™ä¸ªnewCapacityå°±æ˜¯è¯´ï¼ŒoldCapacity + Math.max(minimum growth,preferred growth)
            return elementData = Arrays.copyOf(elementData, newCapacity);
        // å¦‚æœæ˜¯ DEFAULTCAPACITY_EMPTY_ELEMENTDATA æ•°ç»„ï¼Œç›´æ¥åˆ›å»ºæ–°çš„æ•°ç»„å³å¯ã€‚
        } else {
            return elementData = new Object[Math.max(DEFAULT_CAPACITY, minCapacity)];
        }
    }

    private Object[] grow() {
        return grow(size + 1);
    }
```

ä»ä»¥ä¸Šå‡½æ•°å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹å‡ºæ¥ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šåˆå§‹åŒ–ArrayListçš„å¤§å°ã€‚é‚£ä¹ˆå°±ä¼šè¢«èµ‹å€¼ä¸º DEFAULTCAPACITY_EMPTY_ELEMENTDATA æ•°ç»„ã€‚é‚£ä¹ˆåœ¨æ’å…¥ç¬¬ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œå°±ä¼šç›´æ¥æ‰©å®¹ä¸º10.ä¹‹åçš„æ‰©å®¹å°±æ˜¯1.5å€æ‰©å®¹ã€‚å¦‚æœæŒ‡å®šäº†å¤§å°0ï¼Œé‚£ä¹ˆå‰é¢å‡ æ¬¡æ‰©å®¹éƒ½æ˜¯åŠ ä¸€åŠ ä¸€çš„æ‰©å®¹ã€‚åˆ°preferred growthå¤§äº1çš„æ—¶å€™ï¼Œå°±æ˜¯1.5å€çš„æ‰©å®¹äº†ã€‚

æ€»çš„æ¥è¯´ï¼Œè¦è®°ä½ä»¥ä¸‹å‡ ç‚¹

- å¦‚æœæå‰çŸ¥é“è¦æ’å…¥å…ƒç´ çš„æ•°é‡ï¼Œå°½é‡æŒ‡å®šå¤§å°åˆ›å»ºArrayListï¼Œé¿å…æ‰©å®¹ã€‚
- å¦‚æœæ²¡æœ‰æŒ‡å®šå¤§å°ï¼Œæˆ‘ä»¬ç”¨çš„æœ€å¤šçš„å°±æ˜¯è¿™ç§æ–¹å¼ã€‚ç„¶ååœ¨æ’å…¥ç¬¬ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™çš„æ‰©å®¹ï¼Œä¼šç›´æ¥ç»™ä¸€ä¸ªé»˜è®¤å¤§å°10ã€‚
- æ•°ç»„çš„æ‰©å®¹é»˜è®¤æ˜¯1.5å€çš„ï¼Œæœ‰ä¸€ç‚¹ç‚¹ä¾‹å¤–å°±æ˜¯ï¼Œæ•°ç»„å¦‚æœé•¿åº¦æ˜¯å°äº4çš„è¯æ˜¯ï¼ŒåŠ ä¸€åŠ ä¸€æ‰©å®¹çš„ã€‚å…·ä½“çœ‹ä»£ç ã€‚

> ç§»é™¤å…ƒç´ 

- ç§»é™¤å•ä¸ªå…ƒç´ 
  - é¦–å…ˆåˆ¤æ–­indexçš„å€¼æ˜¯å¦åˆæ³•
  - ç„¶åä¿å­˜å°†è¦è¢«ç§»é™¤çš„é‚£ä¸ªä½ç½®çš„å€¼
  - ç„¶åè°ƒç”¨fastRemoveè¿›è¡Œç§»é™¤ï¼ˆå°±æ˜¯æŠŠindex+1åˆ°æœ«å°¾çš„å€¼å¾€å‰ç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼‰ã€‚å†æŠŠæœ€åä¸€ä¸ªä½ç½®ç½®ä½nullã€‚åœ¨å°†sizeå‡ä¸€ã€‚
- ç§»é™¤é¦–æ¬¡å‡ºç°çš„é‚£ä¸ªå…ƒç´ 
  - å¦‚æœæ²¡æœ‰æ‰¾åˆ°å°±è¿”å›falseã€‚æ‰¾åˆ°äº†è¿”å›trueã€‚è¿™é‡Œè¦æ³¨æ„çš„å°±æ˜¯ï¼Œæ˜¯é€šè¿‡ä¼ å…¥å…ƒç´ çš„equalsæ–¹æ³•æ¥è¿›è¡Œåˆ¤æ–­å…ƒç´ æ˜¯å¦ç›¸ç­‰çš„ã€‚
- removeAllæ‰¹é‡ç§»é™¤
  - ç”¨ä¸€ä¸ªç±»ä¼¼äºå¿«æ…¢æŒ‡é’ˆçš„ä¸œè¥¿ã€‚æ‰¾åˆ°ç¬¬ä¸€ä¸ªéœ€è¦ç§»é™¤çš„å…ƒç´ ï¼Œç„¶åå¿«æŒ‡é’ˆç»§ç»­å¾€åç§»åŠ¨ï¼Œå¦‚æœè¢«ç§»é™¤é›†åˆä¸­å­˜åœ¨å…ƒç´ åœ¨è¦ç§»é™¤çš„é›†åˆï¼Œé‚£ä¹ˆå¿«æŒ‡é’ˆç»§ç»­å¾€åã€‚ç›´åˆ°ç»“æŸã€‚å†æŠŠæ…¢æŒ‡é’ˆåˆ°ç»“å°¾çš„ä½ç½®çš„å…ƒç´ ç½®ä½nullã€‚

> æŸ¥æ‰¾å•ä¸ªå…ƒç´ 

`#indexOf(Object o)` æ–¹æ³•ï¼ŒæŸ¥æ‰¾é¦–ä¸ªä¸ºæŒ‡å®šå…ƒç´ çš„ä½ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ArrayList.java

public int indexOf(Object o) {
    return indexOfRange(o, 0, size);
}

int indexOfRange(Object o, int start, int end) {
    Object[] es = elementData;
    // o ä¸º null çš„æƒ…å†µ
    if (o == null) {
        for (int i = start; i < end; i++) {
            if (es[i] == null) {
                return i;
            }
        }
    // o é null çš„æƒ…å†µ
    } else {
        for (int i = start; i < end; i++) {
            if (o.equals(es[i])) {
                return i;
            }
        }
    }
    // æ‰¾ä¸åˆ°ï¼Œè¿”å› -1
    return -1;
  }
```

> åºåˆ—åŒ–æ•°ç»„

æ³¨æ„ç‚¹ï¼šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°elementDataæ˜¯ä¸€ä¸ª`transient` ä¿®é¥°çš„å±æ€§ï¼Œä½†æ˜¯ä¸ºå•¥åºåˆ—åŒ–çš„æ—¶å€™è¿˜æ˜¯ä¼šä¿ç•™åˆ°ArrayListä¸­çš„å…ƒç´ å‘¢ï¼Ÿå› ä¸ºåœ¨ArrayListä¸­é‡å†™äº†writeObject,ç„¶åé€ä¸ªå†™å…¥elementDataé‡Œé¢çš„æ•°æ®ï¼Œç›®çš„æ˜¯ä¸ºäº†

èŠ‚çœç©ºé—´ï¼Œå› ä¸ºåŸæ¥elementDataä¸­çš„æ•°ç»„ä¸ä¸€å®šæ˜¯æ»¡çš„ã€‚

```java
// ArrayList.java

@java.io.Serial
private void writeObject(java.io.ObjectOutputStream s)
    throws java.io.IOException {
    // Write out element count, and any hidden stuff
    // è·å¾—å½“å‰çš„æ•°ç»„ä¿®æ”¹æ¬¡æ•°
    int expectedModCount = modCount;

    // <1> å†™å…¥éé™æ€å±æ€§ã€é transient å±æ€§
    s.defaultWriteObject();

    // Write out size as capacity for behavioral compatibility with clone()
    // <2> å†™å…¥ size ï¼Œä¸»è¦ä¸ºäº†ä¸ clone æ–¹æ³•çš„å…¼å®¹
    s.writeInt(size);

    // Write out all elements in the proper order.
    // <3> é€ä¸ªå†™å…¥ elementData æ•°ç»„çš„å…ƒç´ 
    for (int i = 0; i < size; i++) {
        s.writeObject(elementData[i]);
    }

    // å¦‚æœ other ä¿®æ”¹æ¬¡æ•°å‘ç”Ÿæ”¹å˜ï¼Œåˆ™æŠ›å‡º ConcurrentModificationException å¼‚å¸¸
    if (modCount != expectedModCount) {
        throw new ConcurrentModificationException();
    }
}
```

SerializableåŸç† https://juejin.cn/post/6844903718538739720

>  åˆ›å»º Iterator è¿­ä»£å™¨

`#iterator()` æ–¹æ³•ï¼Œåˆ›å»ºè¿­ä»£å™¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿­ä»£å™¨éå† ArrayListã€LinkedList ç­‰ç­‰ List çš„å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ArrayList.java

public Iterator<E> iterator() {
    return new Itr();
}
```

- åˆ›å»º Itr è¿­ä»£å™¨ã€‚

  - Itr å®ç° [`java.util.Iterator`](https://github.com/YunaiV/openjdk/blob/master/src/java.base/share/classes/java/util/List.java) æ¥å£ï¼Œæ˜¯ ArrayList çš„å†…éƒ¨ç±»ã€‚è™½ç„¶è¯´ AbstractList ä¹Ÿæä¾›äº†ä¸€ä¸ª Itr çš„å®ç°ï¼Œä½†æ˜¯ ArrayList ä¸ºäº†æ›´å¥½çš„æ€§èƒ½ï¼Œæ‰€ä»¥è‡ªå·±å®ç°äº†ï¼Œåœ¨å…¶ç±»ä¸Šä¹Ÿæœ‰æ³¨é‡Šâ€œAn optimized version of AbstractList.Itrâ€ã€‚

- `#next()` æ–¹æ³•ï¼Œä¸‹ä¸€ä¸ªå…ƒç´ ã€‚

  - ç®€å•æ¥è¯´å°±æ˜¯è·å–ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœä¸‹ä¸€ä¸ªå…ƒç´ æ˜¯è¶Šç•Œäº†ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰€ä»¥ä½¿ç”¨å‰ä¸€èˆ¬å…ˆä½¿ç”¨ä¸€ä¸ªhasnext()æ–¹æ³•ã€‚

- `#remove()` æ–¹æ³•ï¼Œç§»é™¤å½“å‰å…ƒç´ ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```java
  // ArrayList.java#Itr
  
  public void remove() {
      // å¦‚æœ lastRet å°äº 0 ï¼Œè¯´æ˜æ²¡æœ‰æŒ‡å‘ä»»ä½•å…ƒç´ ï¼ŒæŠ›å‡º IllegalStateException å¼‚å¸¸
      if (lastRet < 0)
          throw new IllegalStateException();
      // æ ¡éªŒæ˜¯å¦æ•°ç»„å‘ç”Ÿäº†å˜åŒ–
      checkForComodification();
  
      try {
          // <1> ç§»é™¤ lastRet ä½ç½®çš„å…ƒç´ 
          ArrayList.this.remove(lastRet);
          // <2> cursor æŒ‡å‘ lastRet ä½ç½®ï¼Œå› ä¸ºè¢«ç§»äº†ï¼Œæ‰€ä»¥éœ€è¦åé€€ä¸‹
          cursor = lastRet;
          // <3> lastRet æ ‡è®°ä¸º -1 ï¼Œå› ä¸ºå½“å‰å…ƒç´ è¢«ç§»é™¤äº†
          lastRet = -1;
          // <4> è®°å½•æ–°çš„æ•°ç»„çš„ä¿®æ”¹æ¬¡æ•°
          expectedModCount = modCount;
      } catch (IndexOutOfBoundsException ex) {
          throw new ConcurrentModificationException();
      }
  }
  ```

**è¿™é‡Œå°±è¦æä¸€ä¸‹é‚£ä¸ªåœ¨éå†æ—¶ä¿®æ”¹ArrayListçš„é—®é¢˜äº†ï¼Œæ€æ ·ä¸€è¾¹éå†ä¸€è¾¹ä¿®æ”¹å‘¢ã€‚**

å½“æˆ‘ä»¬è°ƒç”¨itrçš„next()æ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šä¸€å¼€å§‹å°±æ£€æŸ¥

```
final void checkForComodification() {
    if (modCount != expectedModCount)
        throw new ConcurrentModificationException();
}
```

å½“ä¸ç›¸ç­‰çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å½“æˆ‘ä»¬éå†çš„æ—¶å€™ï¼Œå¦‚æœåˆ é™¤äº†å…ƒç´ æˆ–è€…æ˜¯å¹²äº†å…¶å®ƒæ”¹å˜modCountçš„äº‹æƒ…ï¼Œé‚£ä¹ˆå¿…ç„¶æ˜¯ä¼šæŠ›å‡ºå¼‚å¸¸çš„ã€‚å› ä¸ºï¼Œæˆ‘ä»¬æ²¡æœ‰æŠŠè¿­ä»£å™¨ä¸­çš„expectedModCount ä¸€èµ·æ”¹å˜ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¾—ç”¨itrè‡ªå·±çš„åˆ é™¤æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒè‡ªå·±æä¾›çš„åˆ é™¤æ–¹æ³•ï¼Œåœ¨åˆ é™¤æˆåŠŸä¹‹åï¼Œä¼šå»ä¿®æ”¹ expectedModCount = modCount;æ‰€ä»¥ï¼Œè¿™æ ·å­çš„è¯ï¼Œå°±ä¸ç”¨æ‹…å¿ƒä¼šæœ‰å¼‚å¸¸çš„æŠ›å‡ºã€‚

 ### HashMap

åœ¨hashmapä¸­åº•å±‚å­˜å‚¨çš„æ˜¯ç”¨æ•°ç»„+é“¾è¡¨/çº¢é»‘æ ‘çš„å½¢å¼ã€‚

![ç‚¹å‡»æŸ¥çœ‹æºç½‘é¡µ](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Faliyunzixunbucket.oss-cn-beijing.aliyuncs.com%2Fjpg%2F74959f466f27ab1109af604b71312524.jpg%3Fx-oss-process%3Dimage%2Fresize%2Cp_100%2Fauto-orient%2C1%2Fquality%2Cq_90%2Fformat%2Cjpg%2Fwatermark%2Cimage_eXVuY2VzaGk%3D%2Ct_100&refer=http%3A%2F%2Faliyunzixunbucket.oss-cn-beijing.aliyuncs.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1613725098&t=1788609d285352b726a9f43ed74c8bfd)

åº•å±‚æ•°ç»„æ˜¯ç”¨å±æ€§tableæ¥è¡¨ç¤ºçš„ã€‚

```java
   /**
     * åº•å±‚å­˜å‚¨çš„æ•°ç»„
     *
     * The table, initialized on first use, and resized as
     * necessary. When allocated, length is always a power of two.
     * (We also tolerate length zero in some operations to allow
     * bootstrapping mechanics that are currently not needed.)
     */
    transient Node<K,V>[] table;
```

nodeèŠ‚ç‚¹ï¼Œæ˜¯é“¾è¡¨çš„èŠ‚ç‚¹ã€‚nodeä¹Ÿæ˜¯hashmapçš„ä¸€ä¸ªç±»ã€‚

> æ„é€ å‡½æ•°

```java
 public HashMap(int initialCapacity, float loadFactor) {
        // æ ¡éªŒ initialCapacity å‚æ•°
        if (initialCapacity < 0)
            throw new IllegalArgumentException("Illegal initial capacity: " +
                                               initialCapacity);
        // é¿å… initialCapacity è¶…è¿‡ MAXIMUM_CAPACITY
        if (initialCapacity > MAXIMUM_CAPACITY)
            initialCapacity = MAXIMUM_CAPACITY;
        // æ ¡éªŒ loadFactor å‚æ•°
        if (loadFactor <= 0 || Float.isNaN(loadFactor))
            throw new IllegalArgumentException("Illegal load factor: " +
                                               loadFactor);
        // è®¾ç½® loadFactor å±æ€§
        this.loadFactor = loadFactor;
        // è®¡ç®— threshold é˜€å€¼
        this.threshold = tableSizeFor(initialCapacity);
    }
```

tableSizeFor(initialCapacity); å°±æ˜¯ä¼šè¾“å‡ºæ¯”ä½ ä¼ å…¥çš„é‚£ä¸ªæ•°å­—å¤§çš„äºŒçš„æ•´æ•°æ¬¡å¹‚ã€‚æ¯”å¦‚è¯´ä¼ å…¥7ï¼Œè¾“å‡ºå°±æ˜¯8.ä¼ å…¥ä¸12è¾“å‡ºå°±æ˜¯16.ä¸€å®šæ˜¯æœ€å°çš„å¤§äºä¼ å…¥å€¼çš„ä¸€ä¸ªäºŒçš„æ•´æ•°æ¬¡å¹‚ã€‚

ä¸ºä»€ä¹ˆä¸€å®šå¾—æ˜¯2çš„næ¬¡æ–¹å‘¢ï¼Ÿ

- æé«˜æ€§èƒ½ï¼Œç”¨&æ“ä½œã€‚



**éœ€è¦è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼Œhashmapç”¨çš„æ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„æ–¹å¼ï¼Œåº•å±‚æ•°ç»„åªæœ‰åœ¨putçš„æ—¶å€™æ‰å»çœŸçš„åˆ›å»ºã€‚**

> hash()å‡½æ•°

https://www.zhihu.com/question/20733617/answer/111577937

```java
// HashMap.java

static final int hash(Object key) {
    int h;
    // h = key.hashCode() è®¡ç®—å“ˆå¸Œå€¼
    // ^ (h >>> 16) é«˜ 16 ä½ä¸è‡ªèº«è¿›è¡Œå¼‚æˆ–è®¡ç®—ï¼Œä¿è¯è®¡ç®—å‡ºæ¥çš„ hash æ›´åŠ ç¦»æ•£
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

ç®€å•è¯´æ˜ï¼š

1. ä¸ºä»€ä¹ˆéœ€è¦ä¸é«˜16ä½è¿›è¡Œæ··åˆå¼‚æˆ–ï¼Ÿ

   è¿™ä¸ªé—®é¢˜éœ€è¦ç»“åˆhashmapçš„æ•°ç»„é•¿åº¦æ¥è¯´ã€‚ç¬¬ä¸€ï¼Œå› ä¸ºkeyçš„hashcodeï¼ˆï¼‰è¿”å›çš„æ˜¯ä¸€ä¸ªintå‹çš„æ•°å­—ã€‚ä¸º32ä½ã€‚é‚£ä¹ˆå°†é«˜ä½å’Œä½ä½è¿›è¡Œå¼‚æˆ–æ··åˆå¾—å‡ºæ¥çš„å€¼ä¼šå°†é«˜ä½ä¸€èµ·å‚ä¸è¿ç®—ã€‚

   ç¬¬äºŒï¼Œæˆ‘ä»¬çš„hashmapçš„é•¿åº¦ä¸€å®šæ˜¯2çš„næ¬¡æ–¹çš„é•¿åº¦ã€‚ç„¶åï¼Œéœ€è¦æ ¹æ®hashå€¼ç¡®å®šåœ¨æ•°ç»„ä¸­å“ªä¸ªä½ç½®è¿›è¡Œå­˜æ”¾ã€‚é‚£ä¹ˆåˆ°åº•æ˜¯å“ªä¸ªä½ç½®å‘¢ï¼Ÿå°±æ˜¯è°ƒç”¨ h & (length-1);æ­¤æ—¶ï¼Œlength - 1çš„äºŒè¿›åˆ¶æ˜¯å…¨ä¸º1çš„ï¼Œå°±ä¼šä¿ç•™hashå€¼çš„ä½ä½ã€‚é‚£ä¹ˆï¼Œå¦‚æœä¸Šé¢çš„é‚£ä¸€ç‚¹ä¸­ä¸è¿›è¡Œé«˜ä½ä½æ··åˆè¿ç®—çš„è¯ï¼Œå°±ä¼šå¤§å¤§å¢åŠ ç¢°æ’å‡ ç‡ã€‚

> put()æ–¹æ³•

putæ–¹æ³•å®é™…ä¸Šä¼šè°ƒç”¨putValæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å¤§ä½“ä¸Šåˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ã€‚

1. é¦–å…ˆï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ã€‚
2. å¾—åˆ°å°†ä¼šè¢«æ”¾å…¥æ•°ç»„ä¸­çš„é‚£ä¸ªä½ç½®çš„ä¸‹æ ‡ï¼Œç„¶ååˆ¤æ–­è¿™ä¸ªä¸‹æ ‡å¤„æ˜¯å¦æœ‰å€¼ã€‚å¦‚æœæ²¡æœ‰å€¼ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ªnodeèŠ‚ç‚¹æ”¾å…¥ã€‚å¦‚æœæœ‰å€¼ï¼Œä»£è¡¨å¯èƒ½å‘ç”Ÿå†²çªã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªæœ‰å€¼çš„ç‚¹ï¼Œå¯èƒ½æŒ‚è½½çš„æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸€æ£µæ ‘ã€‚
3. è¿›è¡Œé“¾è¡¨éå†ï¼Œå¦‚æœæ‰¾åˆ°äº†keyæ˜¯ç›¸åŒçš„ï¼Œå¹¶ä¸”è°ƒç”¨equalsæ–¹æ³•ä¹Ÿæ˜¯è¿”å›trueçš„è¯ï¼Œçœ‹åšæ˜¯è¦æ’å…¥çš„èŠ‚ç‚¹çš„keyå·²ç»å­˜åœ¨äºhashmapä¸­äº†ã€‚åˆ™æ‰§è¡Œæ›´æ–°æ“ä½œã€‚å¦‚æœé“¾è¡¨ä¸­æ²¡æœ‰ï¼Œåˆ™åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œæ’å…¥é“¾è¡¨ã€‚ï¼ˆå°¾æ’æ³•ï¼Ÿï¼‰
4. å½“ç„¶ï¼Œå¦‚æœè¿™ä¸ªèŠ‚ç‚¹ä¸ŠæŒ‚è½½çš„å·²ç»æ˜¯æ ‘äº†ï¼Œé‚£ä¹ˆä¼šè½¬åŒ–ä¸ºæ“ä½œçº¢é»‘æ ‘ã€‚

> æ‰©å®¹

ä»…ä»…æ˜¯ä»£ç é•¿äº†ç‚¹ï¼Œé€»è¾‘å¾ˆæ˜ç¡®ï¼Œå°±ä¸¤æ­¥ï¼š1ï¼‰è®¡ç®—æ–°çš„å®¹é‡å’Œæ‰©å®¹é˜€å€¼ï¼Œå¹¶åˆ›å»ºæ–°çš„ `table` æ•°ç»„ï¼›2ï¼‰å°†è€çš„ `table` å¤åˆ¶åˆ°æ–°çš„ `table` æ•°ç»„ä¸­ã€‚

å¦‚æœæ˜¯é»˜è®¤æ„é€ æ–¹æ³•ã€‚å³æ²¡æœ‰ä¼ å…¥åˆå§‹åŒ–å®¹é‡çš„è¯ï¼Œå°±æ˜¯16.

> æ ‘åŒ–å’Œé€€åŒ–ï¼Ÿ

å½“tableå®¹é‡å°äº64æ—¶ï¼Œåªä¼šè°ƒç”¨resizeæ–¹æ³•è¿›è¡Œæ‰©å®¹ã€‚å½“å¤§äº64çš„æ—¶å€™ï¼Œå¹¶ä¸”é“¾è¡¨é•¿åº¦å¤§äºç­‰äº8ï¼Œåˆ™ä¼šè¿›è¡Œæ ‘åŒ–ã€‚ä¸ºä»€ä¹ˆæ˜¯8ï¼Ÿæ ¹æ® [æ³Šæ¾æ¦‚ç‡å‡½æ•°(Poisson distribution)](http://en.wikipedia.org/wiki/Poisson_distribution) ï¼Œå½“é“¾è¡¨é•¿åº¦åˆ°è¾¾ 8 çš„æ¦‚ç‡æ˜¯ 0.00000006 ï¼Œä¸åˆ°åƒä¸‡åˆ†ä¹‹ä¸€ã€‚

å½“æ ‘å†…éƒ¨èŠ‚ç‚¹å°äºç­‰äº6 çš„æ—¶å€™ï¼Œè¿›è¡Œé€€åŒ–ã€‚ä¸ºä»€ä¹ˆæ˜¯6ï¼Ÿå› ä¸ºå¦‚æœæ˜¯7çš„è¯ï¼Œä¼šé¢‘ç¹çš„æ ‘åŒ–å’Œé€€åŒ–ã€‚å½±å“æ€§èƒ½ã€‚

### LinkHashMap

LinkedHashMap å°±æ˜¯å¯¹hashmapçš„ä¸€ç§æ‰©å……ã€‚æä¾›äº†åŸºäºæ’å…¥é¡ºåºçš„è®¿é—®ã€‚

ä¼—æ‰€å‘¨çŸ¥ï¼ŒHashMap æä¾›çš„è®¿é—®ï¼Œæ˜¯**æ— åº**çš„ã€‚è€Œåœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæä¾›**æœ‰åº**è®¿é—®çš„ HashMap ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œæˆ‘ä»¬å°±æœ‰ä¸¤ç§é€‰æ‹©ï¼š

- TreeMap ï¼šæŒ‰ç…§ key çš„é¡ºåºã€‚
- LinkedHashMap ï¼šæŒ‰ç…§ key çš„æ’å…¥å’Œè®¿é—®çš„é¡ºåºã€‚

LinkedHashMap ï¼Œåœ¨ HashMap çš„åŸºç¡€ä¹‹ä¸Šï¼Œæä¾›äº†**é¡ºåº**è®¿é—®çš„ç‰¹æ€§ã€‚è€Œè¿™é‡Œçš„é¡ºåºï¼ŒåŒ…æ‹¬ä¸¤ç§ï¼š

- æŒ‰ç…§ key-value çš„**æ’å…¥**é¡ºåºè¿›è¡Œè®¿é—®ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œç›¸ä¿¡å¤§å¤šæ•°äººéƒ½çŸ¥é“ã€‚

- æŒ‰ç…§ key-value çš„**è®¿é—®**é¡ºåºè¿›è¡Œè®¿é—®ã€‚

  > é¢è¯•ä¸­ï¼Œæœ‰äº›é¢è¯•å®˜ä¼šå–œæ¬¢é—®ä½ ï¼Œå¦‚ä½•å®ç°ä¸€ä¸ª LRU çš„ç¼“å­˜ã€‚

å®é™…ä¸Šï¼ŒLinkedHashMap å¯ä»¥ç†è§£æˆæ˜¯ LinkedList + HashMap çš„ç»„åˆã€‚

![ç±»å›¾](http://static.iocoder.cn/images/JDK/2019_12_10/01.png)

![image-20210120192947353](https://gitee.com/qiyuejie/qiyue/raw/master/img/image-20210120192947353.png)

> Entry å±æ€§

LinkedHashMapå¯ä»¥çœ‹æˆæ˜¯é“¾è¡¨å’Œhashmapçš„ç»“åˆã€‚

å…¶å®åœ¨LinkedHashMapä¸­ï¼Œæœ‰ä»¥ä¸‹çš„å®ç°ç±»ã€‚Nodeæ˜¯hashmapä¸­çš„æ•°ç»„çš„æ•°ç»„ç±»å‹ã€‚é‚£ä¹ˆï¼Œå¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ°ï¼Œå…¶å®å°±æ˜¯æŠŠnodeæ·»åŠ äº†ä¸€ä¸ªå‰æŒ‡é’ˆå’Œä¸€ä¸ªåæŒ‡é’ˆã€‚å½¢æˆäº†ä¸€ä¸ªç±»ä¼¼äºé“¾è¡¨çš„å½¢å¼ã€‚

```java
   /**
     * HashMap.Node subclass for normal LinkedHashMap entries.
     */
    static class Entry<K,V> extends HashMap.Node<K,V> {

        Entry<K,V> before, // å‰ä¸€ä¸ªèŠ‚ç‚¹
                after; // åä¸€ä¸ªèŠ‚ç‚¹

        Entry(int hash, K key, V value, Node<K,V> next) {
            super(hash, key, value, next);
        }

    }
```

![Node ç±»å›¾](http://static.iocoder.cn/images/JDK/2019_12_07/04.jpg)

> è®¿é—®é¡ºåº

åœ¨è¿™ä¸ªç±»ä¸­æœ‰ä¸€ä¸ª`accessOrder` å±æ€§ï¼Œå†³å®šäº† LinkedHashMap çš„é¡ºåºã€‚ä¹Ÿå°±æ˜¯è¯´:

- `true` æ—¶ï¼Œå½“ Entry èŠ‚ç‚¹è¢«è®¿é—®æ—¶ï¼Œæ”¾ç½®åˆ°é“¾è¡¨çš„ç»“å°¾ï¼Œè¢« `tail` æŒ‡å‘ã€‚
- `false` æ—¶ï¼Œå½“ Entry èŠ‚ç‚¹è¢«æ·»åŠ æ—¶ï¼Œæ”¾ç½®åˆ°é“¾è¡¨çš„ç»“å°¾ï¼Œè¢« `tail` æŒ‡å‘ã€‚å¦‚æœæ’å…¥çš„ key å¯¹åº”çš„ Entry èŠ‚ç‚¹å·²ç»å­˜åœ¨ï¼Œä¹Ÿä¼šè¢«æ”¾åˆ°ç»“å°¾ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨hashmapä¸­ï¼Œæˆ‘ä»¬çš„èŠ‚ç‚¹è®¿é—®æ–¹æ³•æ˜¯ `get(Object key)`ã€‚é‚£ä¹ˆåœ¨è¿™ä¸ªgetæ–¹æ³•ä¸­å¹¶æ²¡æœ‰å¯¹è®¿é—®è¿‡åçš„å›è°ƒã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬åœ¨LinkedHashMap å°±éœ€è¦è‡ªå·±å»é‡å†™è¿™ä¸ªgetæ–¹æ³•ï¼Œä½¿å¾—æˆ‘ä»¬åœ¨è®¿é—®äº†è¿™ä¸ªèŠ‚ç‚¹ä¹‹åï¼Œå°±æŠŠè¿™ä¸ªåˆšåˆšè¢«è®¿é—®çš„èŠ‚ç‚¹æ”¾åˆ°æœ€åå»ã€‚

> éå†

éå†æ¨èä½¿ç”¨forEachï¼ˆï¼‰æ–¹æ³•ã€‚



æ¥å¯¹ LinkedHashMap åšä¸€ä¸ªç®€å•çš„å°ç»“ï¼š

- LinkedHashMap æ˜¯ HashMap çš„å­ç±»ï¼Œå¢åŠ äº†

  é¡ºåºè®¿é—®çš„ç‰¹æ€§ã€‚

  - ã€é»˜è®¤ã€‘å½“ `accessOrder = false` æ—¶ï¼ŒæŒ‰ç…§ key-value çš„**æ’å…¥**é¡ºåºè¿›è¡Œè®¿é—®ã€‚
  - å½“ `accessOrder = true` æ—¶ï¼ŒæŒ‰ç…§ key-value çš„**è¯»å–**é¡ºåºè¿›è¡Œè®¿é—®ã€‚

- LinkedHashMap çš„**é¡ºåº**ç‰¹æ€§ï¼Œé€šè¿‡å†…éƒ¨çš„åŒå‘é“¾è¡¨å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒçœ‹æˆæ˜¯ LinkedList + LinkedHashMap çš„ç»„åˆã€‚

- LinkedHashMap é€šè¿‡é‡å†™ HashMap æä¾›çš„å›è°ƒæ–¹æ³•ï¼Œä»è€Œå®ç°å…¶å¯¹**é¡ºåº**çš„ç‰¹æ€§çš„å¤„ç†ã€‚åŒæ—¶ï¼Œå› ä¸º LinkedHashMap çš„**é¡ºåº**ç‰¹æ€§ï¼Œéœ€è¦é‡å†™ `#keysToArray(T[] a)` ç­‰**éå†**ç›¸å…³çš„æ–¹æ³•ã€‚

- LinkedHashMap å¯ä»¥æ–¹ä¾¿å®ç° LRU ç®—æ³•çš„ç¼“å­˜ã€‚

### HashSet 

HashSet æ˜¯åŸºäº HashMap çš„ Set å®ç°ç±»ã€‚

å±æ€§

HashSet åªæœ‰ä¸€ä¸ªå±æ€§ï¼Œé‚£å°±æ˜¯ `map` ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java 
// HashSet.java

private transient HashMap<E, Object> map;
```

- `map` çš„ key ï¼Œå­˜å‚¨ HashSet çš„æ¯ä¸ª key ã€‚

- `map` çš„ value ï¼Œå› ä¸º HashSet æ²¡æœ‰ value çš„éœ€è¦ï¼Œæ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„ `PRESENT` å³å¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

  ```java
  // HashSet.java
  
  // Dummy value to associate with an Object in the backing Map
  private static final Object PRESENT = new Object();
  ```

### TreeMap![ç±»å›¾](http://static.iocoder.cn/images/JDK/2019_12_13_02/01.png)

treemapå°±æ˜¯ä¸€æ£µçº¢é»‘æ ‘ã€‚

treemapæ˜¯æŒ‰ç…§é‡Œé¢çš„`private final Comparator<? super K> comparator;`è¿›è¡Œæ’åºçš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºçš„æ—¶å€™æŒ‡å®šä¸€ä¸ªcomparatorã€‚é‚£ä¹ˆï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™ä¼šç”¨keyçš„comparatorã€‚æ‰€ä»¥è¯´ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¾“å‡ºçš„é¡ºåºå’Œä½ å­˜å…¥çš„é¡ºåºæ˜¯ä¸ä¸€æ ·çš„ã€‚ä½†æ˜¯éå¾—è¦æŒ‰å­˜å…¥é¡ºåºç»™è¾“å‡ºçš„è¯ã€‚å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªcomparatorä¼ å…¥ã€‚

```java
public static void findCircleNum() {
        TreeMap<String, String> mp = new TreeMap<>((k1,k2)->{
            return 1;
        });
        mp.put("k1","v1");
        mp.put("k4","v1");
        mp.put("k2","v1");
        mp.put("k3","v1");
        mp.put("k7","v1");

        mp.forEach((k,v)->{
            System.out.println("k:" + k );
            System.out.println("v:" + v );
        });

    }

    public static void main(String[] args) {
        findCircleNum();
    }

//////////////////////////////
k:k1
v:v1
k:k4
v:v1
k:k2
v:v1
k:k3
v:v1
k:k7
v:v1

Process finished with exit code 0

```

- TreeMap æŒ‰ç…§ key çš„**é¡ºåº**çš„ Map å®ç°ç±»ï¼Œåº•å±‚é‡‡ç”¨**çº¢é»‘æ ‘**æ¥å®ç°å­˜å‚¨ã€‚
- TreeMap å› ä¸ºé‡‡ç”¨æ ‘ç»“æ„ï¼Œæ‰€ä»¥æ— éœ€åˆå§‹è€ƒè™‘åƒ HashMap è€ƒè™‘**å®¹é‡**é—®é¢˜ï¼Œä¹Ÿä¸å­˜åœ¨æ‰©å®¹é—®é¢˜ã€‚
- TreeMap çš„ **key** ä¸å…è®¸ä¸ºç©º( `null` )ï¼Œå¯èƒ½æ˜¯å› ä¸ºçº¢é»‘æ ‘æ˜¯ä¸€é¢—äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œéœ€è¦å¯¹ key è¿›è¡Œæ’åºã€‚
- TreeMap çš„æŸ¥æ‰¾ã€æ·»åŠ ã€åˆ é™¤ key-value é”®å€¼å¯¹çš„**å¹³å‡**æ—¶é—´å¤æ‚åº¦ä¸º `O(logN)` ã€‚åŸå› æ˜¯ï¼ŒTreeMap é‡‡ç”¨çº¢é»‘æ ‘ï¼Œæ“ä½œéƒ½éœ€è¦ç»è¿‡äºŒåˆ†æŸ¥æ‰¾ï¼Œè€ŒäºŒåˆ†æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦æ˜¯ `O(logN)` ã€‚
- ç›¸æ¯” HashMap æ¥è¯´ï¼ŒTreeMap ä¸ä»…ä»…æ”¯æŒæŒ‡å®š key çš„æŸ¥æ‰¾ï¼Œä¹Ÿæ”¯æŒ key **èŒƒå›´**çš„æŸ¥æ‰¾ã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿå¾—ç›Šäº TreeMap æ•°æ®ç»“æ„èƒ½å¤Ÿæä¾›çš„æœ‰åºç‰¹æ€§ã€‚

### ConcurrentHashMap

- 1.7

https://www.itqiankun.com/article/concurrenthashmap-principle

> æ„é€ å‡½æ•°

![image-20210406223115707](file://D:\TyporaImages\image-20210406223115707.png?lastModify=1617719533)

æœ€åé‚£ä¸ªcapï¼Œæ ¹æ®intialCapacityç¡®å®šSegmentçš„å®¹é‡çš„å¤§å°ï¼Œæ¯ä¸€ä¸ªSegmentçš„å®¹é‡å¤§å°ä¹Ÿæ˜¯2çš„æŒ‡æ•°ï¼ˆcapçš„å¤§å°ä¹Ÿæ˜¯2çš„æ¬¡å¹‚ï¼‰ï¼ŒåŒæ ·ä½¿ä¸ºäº†åŠ å¿«hashçš„è¿‡ç¨‹ã€‚

> getæ“ä½œ

![image-20210407085042040](../../TyporaImages/image-20210407085042040.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨segmentä¸­ï¼Œä¹Ÿæ˜¯æœ‰ä¸€ä¸ªhashEntryçš„æ•°ç»„çš„ã€‚HashEntryæ•°ç»„çš„é•¿åº¦ä¹Ÿæ˜¯2çš„æ¬¡å¹‚ã€‚

æœ‰ä¸€ç‚¹å’Œä¹‹å‰ä¸åŒã€‚ç¡®å®šsegmentæ•°ç»„çš„ä½ç½®ç”¨çš„æ˜¯é«˜nä½&segmentMaskæ¥å¾—åˆ°çš„ã€‚åœ¨ç¡®å®šäº†æ˜¯å“ªä¸ªsegmentä¹‹åï¼Œåœ¨segmentä¸­ä¹Ÿæœ‰HashEntryæ•°ç»„ã€‚å®šä½hashentryæ•°ç»„çš„ä½ç½®ç”¨çš„æ˜¯keyçš„hashå€¼ä¸Entryæ•°ç»„çš„é•¿åº¦å‡ä¸€è¿›è¡Œä¸æ“ä½œã€‚è¿™é‡Œä¼¼ä¹æ²¡æœ‰ç”¨åˆ°hashå€¼é«˜ä½16ä½è¿›è¡Œä¸æ“ä½œæ¥å¢åŠ æ•£åˆ—ã€‚

getæ“ä½œæ˜¯ä¸åŠ é”çš„ã€‚æ•´ä¸ªçš„ä¸€ä¸ªè¿‡ç¨‹å°±æ˜¯ï¼Œé€šè¿‡hashå€¼çš„é«˜nä¸ºæ‰¾åˆ°segmentæ•°ç»„çš„ä½ç½®ã€‚å†æ ¹æ®hashå€¼çš„ä½ä½å¾—åˆ°HashEntryæ•°ç»„ä¸­çš„ä½ç½®ã€‚ç„¶ååœ¨å¾—åˆ°å¤´ç»“ç‚¹ï¼Œéå†å¤´ç»“ç‚¹å°±è¡Œã€‚ç„¶åå›å»éå†è¿™ä¸ªé“¾è¡¨ï¼Œå½“åˆ°ç»“å°¾éƒ½æ²¡æœ‰æ‰¾åˆ°å°±è¿”å›nullã€‚ä¸ç„¶ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œè¿˜éœ€è¦åˆ¤æ–­valueçš„å€¼æ˜¯ä¸æ˜¯nullï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™å…¶å®ƒçš„èŠ‚ç‚¹å¯èƒ½æ­£åœ¨ä¿®æ”¹ï¼Œæˆ–è€…å¢åŠ æŸä¸ªèŠ‚ç‚¹ã€‚æ­¤æ—¶å†å»åŠ é”è¯»å–ã€‚ä¸ç„¶çš„è¯ä¸ç”¨åŠ é”ã€‚è¿™æ ·å°±æå‡äº†å¹¶å‘æ€§ã€‚

> remove å’Œ put

è¿™äº›æ“ä½œéƒ½æ˜¯éœ€è¦åŠ é”çš„ã€‚ç›´æ¥ç”¨æ˜¾ç¤ºé”åŠ é”å³å¯ï¼Œç„¶ååœ¨é”é‡Œé¢è¿›è¡Œå¸¸è§„çš„æ“ä½œã€‚åœ¨finalyä¸­è§£é”å³å¯ã€‚

- 1.8

https://www.itqiankun.com/article/1608083337061

ConcurrentHashMapåˆ™å¯ä»¥æ”¯æŒå¹¶å‘çš„è¯»å†™ã€‚è·Ÿ1.7ç‰ˆæœ¬ç›¸æ¯”ï¼Œ1.8ç‰ˆæœ¬åˆæœ‰äº†å¾ˆå¤§çš„å˜åŒ–ï¼Œå·²ç»æŠ›å¼ƒäº†Segmentçš„æ¦‚å¿µï¼Œè™½ç„¶æºç é‡Œé¢è¿˜ä¿ç•™äº†ï¼Œä¹Ÿåªæ˜¯ä¸ºäº†å…¼å®¹æ€§çš„è€ƒè™‘ã€‚

1.8ä¸­ä¸»è¦æ˜¯é€šè¿‡syncå…³é”®å­—å’ŒUnsafeæ¥ä¿è¯å®‰å…¨çš„ã€‚åœ¨putæ“ä½œéœ€è¦ä¿®æ”¹å…ƒç´ çš„å€¼çš„æ—¶å€™éƒ½ä¼šç”¨syncåŒæ­¥ä»£ç å—æ¥åšåŒæ­¥ã€‚

### fast-failï¼Œfast-safe æœºåˆ¶

https://blog.csdn.net/zymx14/article/details/78394464?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.control

#### fail-fast ( å¿«é€Ÿå¤±è´¥ )

fail-fast:ç›´æ¥åœ¨å®¹å™¨ä¸Šè¿›è¡Œéå†ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°å®¹å™¨ä¸­çš„æ•°æ®è¢«ä¿®æ”¹äº†ï¼Œä¼šç«‹åˆ»æŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸å¯¼è‡´éå†å¤±è´¥ã€‚java.utilåŒ…ä¸‹çš„é›†åˆç±»éƒ½æ˜¯å¿«é€Ÿå¤±è´¥æœºåˆ¶çš„, å¸¸è§çš„çš„ä½¿ç”¨fail-fastæ–¹å¼éå†çš„å®¹å™¨æœ‰HashMapå’ŒArrayListç­‰ã€‚

åœ¨ä½¿ç”¨è¿­ä»£å™¨éå†ä¸€ä¸ªé›†åˆå¯¹è±¡æ—¶,æ¯”å¦‚å¢å¼ºfor,å¦‚æœéå†è¿‡ç¨‹ä¸­å¯¹é›†åˆå¯¹è±¡çš„å†…å®¹è¿›è¡Œäº†ä¿®æ”¹(å¢åˆ æ”¹),ä¼šæŠ›å‡ºConcurrentModificationException å¼‚å¸¸.

#### fail-safe ( å®‰å…¨å¤±è´¥ )

fail-safe:è¿™ç§éå†åŸºäºå®¹å™¨çš„ä¸€ä¸ªå…‹éš†ã€‚å› æ­¤ï¼Œå¯¹å®¹å™¨å†…å®¹çš„ä¿®æ”¹ä¸å½±å“éå†ã€‚java.util.concurrentåŒ…ä¸‹çš„å®¹å™¨éƒ½æ˜¯å®‰å…¨å¤±è´¥çš„,å¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä½¿ç”¨,å¹¶å‘ä¿®æ”¹ã€‚å¸¸è§çš„çš„ä½¿ç”¨fail-safeæ–¹å¼éå†çš„å®¹å™¨æœ‰ConcerrentHashMapå’ŒCopyOnWriteArrayListç­‰ã€‚

**åŸç†ï¼š**

é‡‡ç”¨å®‰å…¨å¤±è´¥æœºåˆ¶çš„é›†åˆå®¹å™¨ï¼Œåœ¨éå†æ—¶ä¸æ˜¯ç›´æ¥åœ¨é›†åˆå†…å®¹ä¸Šè®¿é—®çš„ï¼Œè€Œæ˜¯å…ˆå¤åˆ¶åŸæœ‰é›†åˆå†…å®¹ï¼Œåœ¨æ‹·è´çš„é›†åˆä¸Šè¿›è¡Œéå†ã€‚ç”±äºè¿­ä»£æ—¶æ˜¯å¯¹åŸé›†åˆçš„æ‹·è´è¿›è¡Œéå†ï¼Œæ‰€ä»¥åœ¨éå†è¿‡ç¨‹ä¸­å¯¹åŸé›†åˆæ‰€ä½œçš„ä¿®æ”¹å¹¶ä¸èƒ½è¢«è¿­ä»£å™¨æ£€æµ‹åˆ°ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘Concurrent Modification Exceptionã€‚

**ç¼ºç‚¹**ï¼šåŸºäºæ‹·è´å†…å®¹çš„ä¼˜ç‚¹æ˜¯é¿å…äº†Concurrent Modification Exceptionï¼Œä½†åŒæ ·åœ°ï¼Œè¿­ä»£å™¨å¹¶ä¸èƒ½è®¿é—®åˆ°ä¿®æ”¹åçš„å†…å®¹ï¼Œå³ï¼šè¿­ä»£å™¨éå†çš„æ˜¯å¼€å§‹éå†é‚£ä¸€åˆ»æ‹¿åˆ°çš„é›†åˆæ‹·è´ï¼Œåœ¨éå†æœŸé—´åŸé›†åˆå‘ç”Ÿçš„ä¿®æ”¹è¿­ä»£å™¨æ˜¯ä¸çŸ¥é“çš„ã€‚

### CopyOnWriteArrayList

è¿™ä¸ªå°±æ˜¯è¯»ä¸åŠ é”ï¼Œå†™åŠ é”ã€‚ç”¨äº†è¯»å†™åˆ†ç¦»çš„æ€æƒ³ã€‚

è¯•ç”¨åœºæ™¯ï¼šå½“ä¸€æ‰¹æ•°æ®è¢«é¢‘ç¹è®¿é—®ï¼Œä½†æ˜¯åªæœ‰å¾ˆå°‘çš„æ—¶å€™ä¼šå»å†™ã€‚é‚£ä¹ˆå°±å¯ä»¥ç”¨è¿™ä¸ªCopyOnWriteArrayListã€‚

ä¸»è¦åŸç†ï¼šåœ¨å†™çš„æ—¶å€™ï¼Œå¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„æ•°ç»„å‡ºæ¥ã€‚å½“ç„¶ï¼Œåœ¨å†™çš„æ—¶å€™è¿˜æ˜¯éœ€è¦åŠ é”çš„ã€‚é˜²æ­¢å¤åˆ¶å‡ºå¤šä¸ªæ•°ç»„ã€‚ç„¶åï¼Œå†™çš„æ“ä½œæ˜¯åœ¨è¿™ä¸ªæ–°å¤åˆ¶å‡ºæ¥çš„æ•°ç»„ä¸Šè¿›è¡Œçš„ã€‚é‚£ä¹ˆï¼Œåœ¨æ·»åŠ å®Œæˆä¹‹åï¼Œå°±å¯ä»¥å°†åŸæ•°ç»„æŒ‡å‘æ–°æ•°ç»„ã€‚

åœ¨jdkä¸­å¹¶æ²¡æœ‰è¿™ç§cowçš„mapã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥è‡ªå·±å»å®ç°ä¸€ä¸ªã€‚

##### CopyOnWriteçš„ç¼ºç‚¹ã€€

CopyOnWriteå®¹å™¨æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼Œå³å†…å­˜å ç”¨é—®é¢˜å’Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚æ‰€ä»¥åœ¨å¼€å‘çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚

ã€€ã€€**å†…å­˜å ç”¨é—®é¢˜**ã€‚å› ä¸ºCopyOnWriteçš„å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œå†…å­˜é‡Œä¼šåŒæ—¶é©»æ‰ä¸¤ä¸ªå¯¹è±¡çš„å†…å­˜ï¼Œæ—§çš„å¯¹è±¡å’Œæ–°å†™å…¥çš„å¯¹è±¡ï¼ˆæ³¨æ„:åœ¨å¤åˆ¶çš„æ—¶å€™åªæ˜¯å¤åˆ¶å®¹å™¨é‡Œçš„å¼•ç”¨ï¼Œåªæ˜¯åœ¨å†™çš„æ—¶å€™ä¼šåˆ›å»ºæ–°å¯¹è±¡æ·»åŠ åˆ°æ–°å®¹å™¨é‡Œï¼Œè€Œæ—§å®¹å™¨çš„å¯¹è±¡è¿˜åœ¨ä½¿ç”¨ï¼Œæ‰€ä»¥æœ‰ä¸¤ä»½å¯¹è±¡å†…å­˜ï¼‰ã€‚å¦‚æœè¿™äº›å¯¹è±¡å ç”¨çš„å†…å­˜æ¯”è¾ƒå¤§ï¼Œæ¯”å¦‚è¯´200Må·¦å³ï¼Œé‚£ä¹ˆå†å†™å…¥100Mæ•°æ®è¿›å»ï¼Œå†…å­˜å°±ä¼šå ç”¨300Mï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¾ˆæœ‰å¯èƒ½é€ æˆé¢‘ç¹çš„Yong GCå’ŒFull GCã€‚ä¹‹å‰æˆ‘ä»¬ç³»ç»Ÿä¸­ä½¿ç”¨äº†ä¸€ä¸ªæœåŠ¡ç”±äºæ¯æ™šä½¿ç”¨CopyOnWriteæœºåˆ¶æ›´æ–°å¤§å¯¹è±¡ï¼Œé€ æˆäº†æ¯æ™š15ç§’çš„Full GCï¼Œåº”ç”¨å“åº”æ—¶é—´ä¹Ÿéšä¹‹å˜é•¿ã€‚

ã€€ã€€é’ˆå¯¹å†…å­˜å ç”¨é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡å‹ç¼©å®¹å™¨ä¸­çš„å…ƒç´ çš„æ–¹æ³•æ¥å‡å°‘å¤§å¯¹è±¡çš„å†…å­˜æ¶ˆè€—ï¼Œæ¯”å¦‚ï¼Œå¦‚æœå…ƒç´ å…¨æ˜¯10è¿›åˆ¶çš„æ•°å­—ï¼Œå¯ä»¥è€ƒè™‘æŠŠå®ƒå‹ç¼©æˆ36è¿›åˆ¶æˆ–64è¿›åˆ¶ã€‚æˆ–è€…ä¸ä½¿ç”¨CopyOnWriteå®¹å™¨ï¼Œè€Œä½¿ç”¨å…¶ä»–çš„å¹¶å‘å®¹å™¨ï¼Œå¦‚ConcurrentHashMapã€‚

ã€€ã€€**æ•°æ®ä¸€è‡´æ€§é—®é¢˜**ã€‚CopyOnWriteå®¹å™¨åªèƒ½ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯æ•°æ®çš„å®æ—¶ä¸€è‡´æ€§ã€‚æ‰€ä»¥å¦‚æœä½ å¸Œæœ›å†™å…¥çš„çš„æ•°æ®ï¼Œé©¬ä¸Šèƒ½è¯»åˆ°ï¼Œè¯·ä¸è¦ä½¿ç”¨CopyOnWriteå®¹å™¨ã€‚

 

### ä¸€äº›é¢è¯•é¢˜ï¼š

ğŸ¦… **Collection å’Œ Collections çš„åŒºåˆ«ï¼Ÿ**

- Collection ï¼Œæ˜¯é›†åˆç±»çš„ä¸Šçº§æ¥å£ï¼Œç»§æ‰¿ä¸ä»–çš„æ¥å£ä¸»è¦æœ‰ Set å’ŒList ã€‚

- Collections ï¼Œæ˜¯é’ˆå¯¹é›†åˆç±»çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œå®ƒæä¾›ä¸€ç³»åˆ—é™æ€æ–¹æ³•å®ç°å¯¹å„ç§é›†åˆçš„æœç´¢ã€æ’åºã€çº¿ç¨‹å®‰å…¨åŒ–ç­‰æ“ä½œã€‚

  ###  **ä¸ºä½• Iterator æ¥å£æ²¡æœ‰å…·ä½“çš„å®ç°ï¼Ÿ**

  Iterator æ¥å£ï¼Œå®šä¹‰äº†éå†é›†åˆçš„æ–¹æ³•ï¼Œä½†å®ƒçš„å®ç°åˆ™æ˜¯é›†åˆå®ç°ç±»çš„è´£ä»»ã€‚æ¯ä¸ªèƒ½å¤Ÿè¿”å›ç”¨äºéå†çš„ Iterator çš„é›†åˆç±»éƒ½æœ‰å®ƒè‡ªå·±çš„ Iterator å®ç°å†…éƒ¨ç±»ã€‚

  è¿™å°±å…è®¸é›†åˆç±»å»é€‰æ‹©è¿­ä»£å™¨æ˜¯ fail-fast è¿˜æ˜¯ fail-safe çš„ã€‚æ¯”å¦‚ï¼ŒArrayList è¿­ä»£å™¨æ˜¯ fail-fast çš„ï¼Œè€Œ CopyOnWriteArrayList è¿­ä»£å™¨æ˜¯ fail-safe çš„ã€‚

### hashmapæ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„è¯ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

1. å¤šçº¿ç¨‹ä¸‹æ‰©å®¹æ­»å¾ªç¯ 

JDK1.7ä¸­çš„ HashMap ä½¿ç”¨å¤´æ’æ³•æ’å…¥å…ƒç´ ï¼Œåœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œæ‰©å®¹çš„æ—¶å€™æœ‰å¯èƒ½å¯¼è‡´ç¯å½¢[é“¾è¡¨]()çš„å‡ºç°ï¼Œå½¢æˆæ­»å¾ªç¯ã€‚å› æ­¤ï¼ŒJDK1.8ä½¿ç”¨å°¾æ’æ³•æ’å…¥å…ƒç´ ï¼Œåœ¨æ‰©å®¹æ—¶ä¼šä¿æŒ[é“¾è¡¨]()å…ƒç´ åŸæœ¬çš„é¡ºåºï¼Œä¸ä¼šå‡ºç°ç¯å½¢[é“¾è¡¨]()çš„é—®é¢˜ã€‚å¦‚æœgetä¸€ä¸ªåœ¨æ­¤[é“¾è¡¨](https://www.nowcoder.com/jump/super-jump/word?word=é“¾è¡¨)ä¸­ä¸å­˜åœ¨çš„keyæ—¶ï¼Œå°±ä¼šå‡ºç°æ­»å¾ªç¯äº†ã€‚å¦‚ get(11)æ—¶ï¼Œå°±å‘ç”Ÿäº†æ­»å¾ªç¯ã€‚

2. å¤šçº¿ç¨‹çš„putå¯èƒ½å¯¼è‡´å…ƒç´ çš„ä¸¢å¤± 

å¤šçº¿ç¨‹åŒæ—¶æ‰§è¡Œ put æ“ä½œï¼Œå¦‚æœè®¡ç®—å‡ºæ¥çš„ç´¢å¼•ä½ç½®æ˜¯ç›¸åŒçš„ï¼Œé‚£ä¼šé€ æˆå‰ä¸€ä¸ª key è¢«åä¸€ä¸ª key è¦†ç›–ï¼Œä»è€Œå¯¼è‡´å…ƒç´ çš„ä¸¢å¤±ã€‚æ­¤é—®é¢˜åœ¨JDK 1.7å’Œ JDK 1.8 ä¸­éƒ½å­˜åœ¨ã€‚

3. putå’Œgetå¹¶å‘æ—¶ï¼Œå¯èƒ½å¯¼è‡´getä¸ºnull 

çº¿ç¨‹1æ‰§è¡Œputæ—¶ï¼Œå› ä¸ºå…ƒç´ ä¸ªæ•°è¶…å‡ºthresholdè€Œå¯¼è‡´rehashï¼Œçº¿ç¨‹2æ­¤æ—¶æ‰§è¡Œgetï¼Œæœ‰å¯èƒ½å¯¼è‡´è¿™ä¸ªé—®é¢˜ã€‚æ­¤é—®é¢˜åœ¨JDK 1.7å’Œ JDK 1.8 ä¸­éƒ½å­˜åœ¨ã€‚

å½“rehashçš„æ—¶å€™ï¼Œæœ‰ä¸€ä¸ªæ—¶åˆ»æ˜¯å°†æ–°åˆ›å»ºçš„hashmapèµ‹å€¼ç»™å¼•ç”¨ã€‚é‚£ä¹ˆæ­¤æ—¶è¿™ä¸ªhashmapä¸­ä»€ä¹ˆæ•°æ®éƒ½æ²¡æœ‰ã€‚åˆ™æ­¤æ—¶å†å»getçš„è¯ã€‚å°±ä¼šgetåˆ°ä¸€ä¸ªnullå€¼ã€‚